
| –í—Ö–æ–¥ | ‚îÄ‚ñ∫ | File-Store MS | ‚îÄ‚ñ∫ | File-Analysis MS | ‚îÄ‚ñ∫ | –í—ã—Ö–æ–¥ |
|------|----|---------------|----|------------------|----|--------|
| .txt | ‚Üí  | —Ö—Ä–∞–Ω–∏—Ç .txt   | ‚Üí  | —Å—á–∏—Ç–∞–µ—Ç –∞–±–∑–∞—Ü—ã/—Å–ª–æ–≤–∞/—Å–∏–º–≤–æ–ª—ã, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PNG-–æ–±–ª–∞–∫–æ (QuickChart) | ‚Üí  | JSON + PNG |

---

## 1. –°–æ—Å—Ç–∞–≤

| –°–µ—Ä–≤–∏—Å           | –ü–æ—Ä—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                          |
|------------------|------|-----------------------------------------------------|
| **api-gateway**  | 8000 | ¬´–§–∞—Å–∞–¥¬ª; –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ MS |
| **file-store**   | 8001 | –ó–∞–≥—Ä—É–∂–∞–µ—Ç/–≤—ã–¥–∞—ë—Ç .txt, —Ö—Ä–∞–Ω–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ Postgres |
| **file-analysis**| 8002 | –°—á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –±–µ—Ä—ë—Ç .txt –∏–∑ file-store, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PNG |
| **db\_store**    | 5432 | Postgres 16 (—Ç–∞–±–ª–∏—Ü–∞ `files`)                       |
| **db\_analysis** | 5433 | Postgres 16 (—Ç–∞–±–ª–∏—Ü–∞ `stats`)                       |

> **Database-per-Service** ‚Äì –∫–∞–∂–¥–∞—è –±–∏–∑–Ω–µ—Å-–æ–±–ª–∞—Å—Ç—å –∏–º–µ–µ—Ç —Å–≤–æ—é –ë–î ‚Üí –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏, —á—ë—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã.

---

## 2. –†–µ–∞–ª—å–Ω–∞—è (—á–∏—Å—Ç–∞—è) –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–∏—Å–µ

```

presentation  ‚Üê FastAPI routes / DI
‚îî‚îÄ‚îÄ application/use\_cases  ‚Üê  Interactor-—ã (¬´–°—Ü–µ–Ω–∞—Ä–∏–∏¬ª)
‚îî‚îÄ‚îÄ domain            ‚Üê  Entities + Ports (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã)
‚îî‚îÄ‚îÄ infrastructure ‚Üê  Adapters (SQLAlchemy, –¥–∏—Å–∫, HTTP Gateway)

```

–ü–∞—Ç—Ç–µ—Ä–Ω—ã/–ø—Ä–∏—ë–º—ã üîπ
- **Hexagonal / Ports & Adapters** ‚Äì FileStoreGatewayAdapter, DiskStorageAdapter ‚Ä¶  
- **Repository** ‚Äì `PostgresFileRepository`, `PostgresStatsRepository`
- **Use-case / Interactor** ‚Äì –æ–¥–∏–Ω –∫–ª–∞—Å—Å = –æ–¥–∏–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π (`UploadFileInteractor`, `AnalyseFileInteractor`)
- **DTO / Cmd / Query** ‚Äì —á–∏—Å—Ç—ã–µ Pydantic-–º–æ–¥–µ–ª–∏ –º–µ–∂–¥—É —Å–ª–æ—è–º–∏
- **Dependency Injection** —á–µ—Ä–µ–∑ `Depends()` + `@lru_cache` (= –ª–µ–Ω–∏–≤—ã–π singleton)
- **CQRS-–ª–∞–π—Ç** ‚Äì –∫–æ–º–∞–Ω–¥—ã (`UploadFileCmd`) separados –æ—Ç —á—Ç–µ–Ω–∏—è (`GetFileQuery`)
- **Idempotency** ‚Äì SHA-256 check –≤ `UploadFileInteractor` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏

---

## 3. –î–µ—Ä–µ–≤–æ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ (—Å–≤–µ—Ä—Ö—É –∫–æ—Ä–µ–Ω—å repo)

```

.
‚îú‚îÄ api-gateway/
‚îÇ  ‚îî‚îÄ (FastAPI, routes, Dockerfile)
‚îú‚îÄ file-store/
‚îÇ  ‚îú‚îÄ file\_store/
‚îÇ  ‚îÇ  ‚îú‚îÄ application/
‚îÇ  ‚îÇ  ‚îú‚îÄ domain/
‚îÇ  ‚îÇ  ‚îú‚îÄ infrastructure/
‚îÇ  ‚îÇ  ‚îî‚îÄ presentation/
‚îÇ  ‚îî‚îÄ Dockerfile
‚îú‚îÄ file-analysis/
‚îÇ  ‚îî‚îÄ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
‚îú‚îÄ storage/
‚îÇ  ‚îú‚îÄ store/      ‚Üê —Ç–æ–º –¥–ª—è .txt
‚îÇ  ‚îî‚îÄ analysis/   ‚Üê —Ç–æ–º –¥–ª—è PNG
‚îú‚îÄ docker-compose.yml
‚îî‚îÄ tests/         ‚Üê unit + e2e (pytest)

````

---

## 4. Public API (via API-Gateway :8000)

| –ú–µ—Ç–æ–¥ + URL                     | –¢–µ–ª–æ / –ø–∞—Ä–∞–º–µ—Ç—Ä—ã              | –û—Ç–≤–µ—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------------------------------|------------------------------|-------|-----------|
| `POST /upload`                  | multipart-form `file`        | `201 {id}` | –ó–∞–≥—Ä—É–∑–∏—Ç—å .txt |
| `GET /files/{uuid}`             | ‚Äì                            | raw .txt | –°–∫–∞—á–∞—Ç—å —Ç–µ–∫—Å—Ç |
| `GET /analyze/{uuid}`           | ‚Äì                            | JSON  | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ + –ø—É—Ç—å –∫ PNG |
| `GET /cloud/{path}`             | ‚Äì                            | image/png | PNG-–æ–±–ª–∞–∫–æ |

‚ùå –æ—à–∏–±–∫–∏:

| –°—Ç–∞—Ç—É—Å | –ö–æ–≥–¥–∞ |
|--------|-------|
| `404`  | —Ñ–∞–π–ª/PNG –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| `415`  | –Ω–µ–≤–µ—Ä–Ω—ã–π `Content-Type` –≤ upload |
| `422`  | –ø–ª–æ—Ö–æ–π UUID / –ø—É—Å—Ç–æ–π multipart |

–ü–æ–ª–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –¥–ª—è Postman –ª–µ–∂–∏—Ç –≤ ‚Äã`/docs/file_analysis_postman_collection.json`.

---

## 5. –ó–∞–ø—É—Å–∫ & —Ç–µ—Å—Ç—ã

```bash
# 1. —Å–æ–±—Ä–∞—Ç—å –∏ —Å—Ç–∞—Ä—Ç–∞–Ω—É—Ç—å
docker compose build
docker compose up
````

## 6. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è                 | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é                       | –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è             |
| -------------------------- | ---------------------------------- | ---------------------------- |
| `FILE_DB_DSN`              | `postgresql+asyncpg://‚Ä¶/store`     | file-store                   |
| `FILE_STORAGE_ROOT`        | `/app/storage` (volume)            | file-store / DiskStorage     |
| `DB_DSN`                   | `postgresql+psycopg2://‚Ä¶/analysis` | file-analysis                |
| `STORAGE_ROOT`             | `/app/storage`                     | file-analysis / DiskStorage  |
| `FILE_STORE_URL`           | `http://file-store:8001`           | file-analysis (HTTP Gateway) |
| `ANALYSIS_URL`             | `http://file-analysis:8002`        | api-gateway                  |
| `MAX_CONN`, `HTTP_TIMEOUT` | 50 / 5 —Å–µ–∫                         | httpx client limits          |

---

## 7. –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–∫–æ—Ä–æ—Ç–∫–æ)

1. **–ó–∞–≥—Ä—É–∑–∫–∞**: API-Gateway –ø—Ä–∏ `POST /upload` –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç —Ñ–∞–π–ª ‚Üí File-Store.
2. File-Store –≤—ã—á–∏—Å–ª—è–µ—Ç SHA-256, –µ—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç ‚Äî –æ—Ç–¥–∞—ë—Ç —Å—Ç–∞—Ä—ã–π UUID, –∏–Ω–∞—á–µ:

   * –∫–ª–∞–¥—ë—Ç .txt –Ω–∞ –¥–∏—Å–∫
   * —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ `db_store.files`
3. **–ê–Ω–∞–ª–∏–∑**: API-Gateway –≤—ã–∑—ã–≤–∞–µ—Ç File-Analysis:

   1. File-Analysis —á–µ—Ä–µ–∑ `FileStoreGatewayAdapter` —Ç—è–Ω–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π .txt
   2. –°—á–∏—Ç–∞–µ—Ç –∞–±–∑–∞—Ü—ã/—Å–ª–æ–≤–∞/—Å–∏–º–≤–æ–ª—ã
   3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ QuickChart (GET `/wordcloud`) ‚Üí –ø–æ–ª—É—á–∞–µ—Ç PNG
   4. PNG –∫–ª–∞–¥—ë—Ç—Å—è –Ω–∞ –¥–∏—Å–∫, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äî –≤ `db_analysis.stats`
4. **–°–∫–∞—á–∏–≤–∞–Ω–∏–µ**: –ª—é–±—ã–µ `.txt` –∏ `.png` –æ—Ç–¥–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é.

---

## 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫—Ä–∞–π–Ω–∏–µ —Å–ª—É—á–∞–∏

–ì–æ—Ç–æ–≤—ã–µ Postman-–∑–∞–ø—Ä–æ—Å—ã –≤–∫–ª—é—á–∞—é—Ç:

| –¢–µ—Å—Ç                                   | –û–∂–∏–¥–∞–Ω–∏–µ           |
| -------------------------------------- | ------------------ |
| upload 0-–±–∞–π—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞               | 201, stats = 0-0-0 |
| –ø–æ–≤—Ç–æ—Ä–Ω—ã–π upload —Ç–æ–≥–æ –∂–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞      | –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ UUID |
| download/analysis –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ UUID | 404                |
| download PNG –ø–æ —Ñ–µ–π–∫–æ–≤–æ–º—É –ø—É—Ç–∏         | 404                |
| upload –±–µ–∑ –ø–æ–ª—è `file`                 | 422                |

(—Å–º. –∫–æ–ª–ª–µ–∫—Ü–∏—é).

---

## 9. –ö–æ–ª–ª–µ–∫—Ü–∏—è postman –∏ —Å–∫—Ä–∏–Ω—ã –ª–µ–∂–∞—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
